# staRburst Package Structure

This document describes the R package structure created for staRburst.

## Overview

staRburst is a complete R package implementing a future backend for
seamless AWS cloud bursting of parallel R workloads.

## Directory Structure

    starburst/
    ├── .github/
    │   └── workflows/
    │       └── R-CMD-check.yaml      # GitHub Actions CI/CD
    ├── R/                             # R source code
    │   ├── plan-starburst.R          # Core future backend implementation
    │   ├── setup.R                   # One-time AWS setup wizard
    │   ├── quota.R                   # Quota management functions
    │   ├── utils.R                   # Helper utilities
    │   └── logs.R                    # Logging and debugging functions
    ├── man/                           # Documentation (generated by roxygen2)
    ├── tests/
    │   ├── testthat/
    │   │   ├── test-plan.R           # Tests for plan functions
    │   │   ├── test-quota.R          # Tests for quota management
    │   │   └── test-utils.R          # Tests for utilities
    │   └── testthat.R                # Test configuration
    ├── vignettes/
    │   └── getting-started.Rmd       # Getting started tutorial
    ├── inst/
    │   └── templates/
    │       ├── Dockerfile.template   # Docker image template
    │       └── worker.R              # Worker script for Fargate containers
    ├── data-raw/                      # Raw data for package development
    ├── DESCRIPTION                    # Package metadata
    ├── NAMESPACE                      # Package namespace (generated)
    ├── LICENSE                        # MIT License
    ├── README.Rmd                     # Package README (renders to .md)
    ├── NEWS.md                        # Version history and changes
    ├── CONTRIBUTING.md                # Contribution guidelines
    ├── ARCHITECTURE.md                # Technical architecture documentation
    ├── ROADMAP.md                     # Development roadmap
    ├── .Rbuildignore                  # Files to exclude from R package build
    ├── .gitignore                     # Git ignore patterns
    └── starburst.Rproj                # RStudio project file

## Core R Files

### R/plan-starburst.R (~435 lines)

- [`plan.starburst()`](https://scttfrdmn.github.io/starburst/reference/plan.starburst.md) -
  Main function to create future plan
- `future_starburst()` - Create futures on AWS
- `value.starburst_future()` - Retrieve results
- `resolved.starburst_future()` - Check if future is resolved
- [`submit_task()`](https://scttfrdmn.github.io/starburst/reference/submit_task.md) -
  Submit task to Fargate
- `submit_fargate_task()` - Actual Fargate task submission
- Wave-based execution logic
- Cleanup and cost tracking

### R/setup.R (~434 lines)

- [`starburst_setup()`](https://scttfrdmn.github.io/starburst/reference/starburst_setup.md) -
  Interactive setup wizard
- AWS resource creation (S3, ECR, ECS, VPC)
- Configuration management
- [`starburst_config()`](https://scttfrdmn.github.io/starburst/reference/starburst_config.md) -
  User preferences
- [`starburst_status()`](https://scttfrdmn.github.io/starburst/reference/starburst_status.md) -
  Show current status
- Helper functions for AWS resources

### R/quota.R (~428 lines)

- [`check_fargate_quota()`](https://scttfrdmn.github.io/starburst/reference/check_fargate_quota.md) -
  Query quota limits
- [`request_quota_increase()`](https://scttfrdmn.github.io/starburst/reference/request_quota_increase.md) -
  Request increase from AWS
- [`starburst_request_quota_increase()`](https://scttfrdmn.github.io/starburst/reference/starburst_request_quota_increase.md) -
  User-facing quota request
- [`starburst_quota_status()`](https://scttfrdmn.github.io/starburst/reference/starburst_quota_status.md) -
  Display quota information
- [`suggest_quota()`](https://scttfrdmn.github.io/starburst/reference/suggest_quota.md) -
  Intelligent quota recommendations
- [`starburst_check_quota_request()`](https://scttfrdmn.github.io/starburst/reference/starburst_check_quota_request.md) -
  Monitor quota requests

### R/utils.R (~400 lines)

- AWS client creation functions
- Serialization helpers
- Cost estimation
- Task management
- Environment synchronization
- S3 upload/download helpers
- Validation functions

### R/logs.R (~80 lines)

- [`starburst_logs()`](https://scttfrdmn.github.io/starburst/reference/starburst_logs.md) -
  View worker logs from CloudWatch
- [`starburst_rebuild_environment()`](https://scttfrdmn.github.io/starburst/reference/starburst_rebuild_environment.md) -
  Rebuild Docker image

## Templates

### inst/templates/Dockerfile.template

- Template for building worker Docker images
- Based on rocker/r-ver
- Includes renv for package management
- Installs AWS CLI and dependencies

### inst/templates/worker.R

- Script that runs inside Fargate containers
- Downloads task from S3
- Restores environment
- Executes user code
- Uploads results back to S3
- Error handling and logging

## Tests

### tests/testthat/test-quota.R

- Tests for quota calculation logic
- Tests for quota suggestions
- Memory parsing tests

### tests/testthat/test-utils.R

- Tests for utility functions
- Validation tests
- Cost estimation tests
- Operator tests

### tests/testthat/test-plan.R

- Tests for plan creation
- Input validation tests
- Plan object structure tests

## Documentation

### vignettes/getting-started.Rmd (~500 lines)

- Complete tutorial with examples
- Monte Carlo simulation example
- Bootstrap resampling example
- Genomics pipeline example
- Data handling patterns
- Cost management guide
- Troubleshooting section
- Best practices

### ARCHITECTURE.md

- System architecture diagrams
- Component deep dive
- Data flow optimization
- Security model
- Performance benchmarks
- Future extensions

### ROADMAP.md

- 20-week development plan
- 10 implementation phases
- Post-v1.0 features
- Success metrics
- Risk mitigation

## Package Metadata

### DESCRIPTION

- Package: starburst
- Version: 0.1.0
- Dependencies:
  - future (\>= 1.33.0)
  - paws.\* (AWS SDK)
  - qs (serialization)
  - renv (environment management)
  - arrow (data frames)
  - crayon, cli, rlang (UI)

### NAMESPACE

- Exports 9 user-facing functions:
  - [`plan.starburst()`](https://scttfrdmn.github.io/starburst/reference/plan.starburst.md)
  - [`starburst_setup()`](https://scttfrdmn.github.io/starburst/reference/starburst_setup.md)
  - [`starburst_config()`](https://scttfrdmn.github.io/starburst/reference/starburst_config.md)
  - [`starburst_status()`](https://scttfrdmn.github.io/starburst/reference/starburst_status.md)
  - [`starburst_quota_status()`](https://scttfrdmn.github.io/starburst/reference/starburst_quota_status.md)
  - [`starburst_request_quota_increase()`](https://scttfrdmn.github.io/starburst/reference/starburst_request_quota_increase.md)
  - [`starburst_check_quota_request()`](https://scttfrdmn.github.io/starburst/reference/starburst_check_quota_request.md)
  - [`starburst_logs()`](https://scttfrdmn.github.io/starburst/reference/starburst_logs.md)
  - [`starburst_rebuild_environment()`](https://scttfrdmn.github.io/starburst/reference/starburst_rebuild_environment.md)

## Key Features Implemented

1.  **future Backend Integration**
    - Complete implementation of future backend protocol
    - Works with furrr, future.apply, targets, etc.
2.  **AWS Resource Management**
    - Automated setup of S3, ECR, ECS, VPC
    - One-time configuration wizard
    - Configuration persistence
3.  **Quota Management**
    - Proactive quota checking
    - Wave-based execution
    - Automatic quota increase requests
    - Status monitoring
4.  **Cost Tracking**
    - Pre-execution cost estimation
    - Real-time cost tracking
    - Cost limits and alerts
5.  **Environment Synchronization**
    - renv-based package management
    - Docker image building
    - ECR caching
6.  **Error Handling**
    - Comprehensive error handling
    - Worker logs via CloudWatch
    - Graceful failure recovery

## Development Status

### Implemented

- ✅ Package structure
- ✅ Core future backend
- ✅ Setup wizard
- ✅ Quota management
- ✅ Cost estimation
- ✅ Tests
- ✅ Documentation
- ✅ CI/CD workflow

### To Implement

- ⏳ Docker image building (placeholder)
- ⏳ Actual Fargate task execution
- ⏳ S3 multipart uploads
- ⏳ CloudWatch logging integration
- ⏳ Advanced serialization (Arrow)

## Next Steps

1.  **Implement Docker Image Building**
    - Use AWS CodeBuild or local Docker
    - Implement renv restore in container
    - Push to ECR with caching
2.  **Complete Task Execution**
    - Implement actual ECS RunTask calls
    - Handle task monitoring
    - Implement result polling
3.  **Add Integration Tests**
    - Tests that actually run on AWS
    - Mock AWS API responses
    - Cost regression tests
4.  **Performance Optimization**
    - Implement parallel S3 uploads
    - Optimize serialization
    - Batch small tasks
5.  **Documentation**
    - Generate man pages with roxygen2
    - Build pkgdown website
    - Add more examples

## Building the Package

``` r
# Install development dependencies
install.packages(c("devtools", "roxygen2", "testthat"))

# Load package
devtools::load_all()

# Run tests
devtools::test()

# Generate documentation
devtools::document()

# Check package
devtools::check()

# Build package
devtools::build()

# Install locally
devtools::install()
```

## Using the Package

``` r
library(starburst)
library(furrr)

# One-time setup
starburst_setup()

# Use with furrr
plan(future_starburst, workers = 50)
results <- future_map(data, expensive_function)
```

## Contributing

See CONTRIBUTING.md for guidelines on contributing to the package.

## License

MIT License - see LICENSE file.
