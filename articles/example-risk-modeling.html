<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example: Parallel Portfolio Risk Modeling • starburst</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example: Parallel Portfolio Risk Modeling">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">starburst</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/getting-started.html">Get Started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-examples" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Examples</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-examples">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Data Processing Examples</h6></li>
    <li><a class="dropdown-item" href="../articles/example-monte-carlo.html">Monte Carlo Simulation</a></li>
    <li><a class="dropdown-item" href="../articles/example-api-calls.html">Bulk API Calls</a></li>
    <li><a class="dropdown-item" href="../articles/example-geospatial.html">Geospatial Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/example-grid-search.html">Model Grid Search</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Business Use Cases</h6></li>
    <li><a class="dropdown-item" href="../articles/example-risk-modeling.html">Financial Risk Modeling</a></li>
    <li><a class="dropdown-item" href="../articles/example-feature-engineering.html">ML Feature Engineering</a></li>
    <li><a class="dropdown-item" href="../articles/example-bootstrap.html">A/B Test Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/example-reports.html">Report Generation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/examples.html">Runnable Scripts</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/scttfrdmn/starburst/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Example: Parallel Portfolio Risk Modeling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/scttfrdmn/starburst/blob/main/vignettes/example-risk-modeling.Rmd" class="external-link"><code>vignettes/example-risk-modeling.Rmd</code></a></small>
      <div class="d-none name"><code>example-risk-modeling.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>Risk modeling in finance requires evaluating portfolios under
thousands of market scenarios. This example demonstrates parallelizing
comprehensive risk analysis including stress testing, Value at Risk
(VaR), Expected Shortfall (ES), and sensitivity analysis.</p>
<p><strong>Use Case</strong>: Financial risk management, stress testing,
regulatory compliance (Basel III), portfolio optimization</p>
<p><strong>Computational Pattern</strong>: Scenario-based parallel
computation with risk metric aggregation</p>
</div>
<div class="section level2">
<h2 id="the-problem">The Problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>You manage a portfolio of 50 assets and need to perform comprehensive
risk analysis: - <strong>Stress testing</strong>: 100 adverse market
scenarios - <strong>VaR calculation</strong>: 10,000 Monte Carlo
simulations - <strong>Sensitivity analysis</strong>: 25 risk factors ×
10 shock levels = 250 scenarios - <strong>Historical VaR</strong>: 1,000
historical scenarios</p>
<p>Total: <strong>11,350 scenario evaluations</strong></p>
<p>Each scenario requires: 1. Applying shocks to risk factors 2.
Repricing all portfolio positions 3. Calculating P&amp;L and risk
metrics 4. Aggregating results</p>
<p>This takes ~0.5 seconds per scenario = <strong>95 minutes</strong>
sequentially.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://starburst.ing" class="external-link">starburst</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generate-sample-portfolio">Generate Sample Portfolio<a class="anchor" aria-label="anchor" href="#generate-sample-portfolio"></a>
</h2>
<p>Create a synthetic multi-asset portfolio:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3141</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define portfolio positions</span></span>
<span><span class="va">n_assets</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="va">portfolio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  asset_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_assets</span>,</span>
<span>  asset_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Asset_"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_assets</span><span class="op">)</span>,</span>
<span>  asset_class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Equity"</span>, <span class="st">"Bond"</span>, <span class="st">"Commodity"</span>, <span class="st">"FX"</span>, <span class="st">"Option"</span><span class="op">)</span>,</span>
<span>                      <span class="va">n_assets</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                      prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  position_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html" class="external-link">rlnorm</a></span><span class="op">(</span><span class="va">n_assets</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1000000</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_assets</span>, <span class="fl">1.0</span>, <span class="fl">0.3</span><span class="op">)</span>,  <span class="co"># Market beta</span></span>
<span>  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Equity"</span>, <span class="st">"Bond"</span>, <span class="st">"Commodity"</span>, <span class="st">"FX"</span>, <span class="st">"Option"</span><span class="op">)</span>,</span>
<span>           <span class="va">n_assets</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>           prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="st">"Bond"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_assets</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">0</span></span>
<span>  <span class="op">)</span>,</span>
<span>  delta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_assets</span>, <span class="fl">0.3</span>, <span class="fl">0.7</span><span class="op">)</span>,  <span class="co"># Options delta</span></span>
<span>  vega <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_assets</span>, <span class="fl">10000</span>, <span class="fl">50000</span><span class="op">)</span>,  <span class="co"># Options vega</span></span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">total_portfolio_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">portfolio</span><span class="op">$</span><span class="va">position_value</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Portfolio Summary:\n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Total value: $%.0f\n"</span>, <span class="va">total_portfolio_value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Number of positions: %d\n"</span>, <span class="va">n_assets</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Asset classes: %s\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">portfolio</span><span class="op">$</span><span class="va">asset_class</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Breakdown by asset class</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"\nAllocation by asset class:\n"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ac</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">portfolio</span><span class="op">$</span><span class="va">asset_class</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pct</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">portfolio</span><span class="op">$</span><span class="va">position_value</span><span class="op">[</span><span class="va">portfolio</span><span class="op">$</span><span class="va">asset_class</span> <span class="op">==</span> <span class="va">ac</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span></span>
<span>         <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  %s: %.1f%%\n"</span>, <span class="va">ac</span>, <span class="va">pct</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Output</strong>:</p>
<pre><code>Portfolio Summary:
  Total value: $62,458,392
  Number of positions: 50
  Asset classes: Equity, Bond, Commodity, FX, Option

Allocation by asset class:
  Equity: 45.2%
  Bond: 28.7%
  Commodity: 11.3%
  FX: 8.9%
  Option: 5.9%</code></pre>
</div>
<div class="section level2">
<h2 id="risk-scenario-generation">Risk Scenario Generation<a class="anchor" aria-label="anchor" href="#risk-scenario-generation"></a>
</h2>
<p>Define functions to generate different types of risk scenarios:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate stress test scenarios</span></span>
<span><span class="va">generate_stress_scenarios</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_scenarios</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_scenarios</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Define adverse market moves</span></span>
<span>    <span class="va">scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      scenario_id <span class="op">=</span> <span class="va">i</span>,</span>
<span>      scenario_type <span class="op">=</span> <span class="st">"stress_test"</span>,</span>
<span>      equity_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">0.15</span>, <span class="fl">0.05</span><span class="op">)</span>,  <span class="co"># Average -15% with volatility</span></span>
<span>      rate_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.02</span>, <span class="fl">0.01</span><span class="op">)</span>,     <span class="co"># +200bps average</span></span>
<span>      vol_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.5</span>, <span class="fl">0.2</span><span class="op">)</span>,        <span class="co"># +50% volatility</span></span>
<span>      fx_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">0.05</span>, <span class="fl">0.03</span><span class="op">)</span>,      <span class="co"># -5% average</span></span>
<span>      commodity_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">0.10</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">scenarios</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">scenario</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">scenarios</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate Monte Carlo scenarios</span></span>
<span><span class="va">generate_mc_scenarios</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_scenarios</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_scenarios</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      scenario_id <span class="op">=</span> <span class="fl">1000</span> <span class="op">+</span> <span class="va">i</span>,</span>
<span>      scenario_type <span class="op">=</span> <span class="st">"monte_carlo"</span>,</span>
<span>      equity_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.10</span><span class="op">)</span>,</span>
<span>      rate_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.005</span><span class="op">)</span>,</span>
<span>      vol_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span>,</span>
<span>      fx_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>      commodity_shock <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.12</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">scenarios</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">scenario</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">scenarios</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate sensitivity scenarios (grid around current values)</span></span>
<span><span class="va">generate_sensitivity_scenarios</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">scenario_id</span> <span class="op">&lt;-</span> <span class="fl">20000</span></span>
<span></span>
<span>  <span class="va">risk_factors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"equity"</span>, <span class="st">"rate"</span>, <span class="st">"vol"</span>, <span class="st">"fx"</span>, <span class="st">"commodity"</span><span class="op">)</span></span>
<span>  <span class="va">shock_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.02</span>, <span class="fl">0.02</span>, by <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span>  <span class="co"># -2% to +2% in 0.5% steps</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">factor</span> <span class="kw">in</span> <span class="va">risk_factors</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">shock</span> <span class="kw">in</span> <span class="va">shock_levels</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">scenario_id</span> <span class="op">&lt;-</span> <span class="va">scenario_id</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>      <span class="va">scenario</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        scenario_id <span class="op">=</span> <span class="va">scenario_id</span>,</span>
<span>        scenario_type <span class="op">=</span> <span class="st">"sensitivity"</span>,</span>
<span>        risk_factor <span class="op">=</span> <span class="va">factor</span>,</span>
<span>        equity_shock <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">factor</span> <span class="op">==</span> <span class="st">"equity"</span><span class="op">)</span> <span class="va">shock</span> <span class="kw">else</span> <span class="fl">0</span>,</span>
<span>        rate_shock <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">factor</span> <span class="op">==</span> <span class="st">"rate"</span><span class="op">)</span> <span class="va">shock</span> <span class="kw">else</span> <span class="fl">0</span>,</span>
<span>        vol_shock <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">factor</span> <span class="op">==</span> <span class="st">"vol"</span><span class="op">)</span> <span class="va">shock</span> <span class="kw">else</span> <span class="fl">0</span>,</span>
<span>        fx_shock <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">factor</span> <span class="op">==</span> <span class="st">"fx"</span><span class="op">)</span> <span class="va">shock</span> <span class="kw">else</span> <span class="fl">0</span>,</span>
<span>        commodity_shock <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">factor</span> <span class="op">==</span> <span class="st">"commodity"</span><span class="op">)</span> <span class="va">shock</span> <span class="kw">else</span> <span class="fl">0</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">scenarios</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">scenarios</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">scenario</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">scenarios</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="portfolio-valuation-function">Portfolio Valuation Function<a class="anchor" aria-label="anchor" href="#portfolio-valuation-function"></a>
</h2>
<p>Define a function that values the portfolio under a scenario:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">value_portfolio_scenario</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">scenario</span>, <span class="va">portfolio_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Simulate computation time</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.001</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Calculate position-level P&amp;L</span></span>
<span>  <span class="va">position_pnl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">portfolio_data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">portfolio_data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">asset</span> <span class="op">&lt;-</span> <span class="va">portfolio_data</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span></span>
<span>    <span class="co"># Apply shocks based on asset class</span></span>
<span>    <span class="va">pnl</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">asset</span><span class="op">$</span><span class="va">asset_class</span> <span class="op">==</span> <span class="st">"Equity"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Equity: affected by equity shock and beta</span></span>
<span>      <span class="va">pnl</span> <span class="op">&lt;-</span> <span class="va">asset</span><span class="op">$</span><span class="va">position_value</span> <span class="op">*</span> <span class="va">scenario</span><span class="op">$</span><span class="va">equity_shock</span> <span class="op">*</span> <span class="va">asset</span><span class="op">$</span><span class="va">beta</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">asset</span><span class="op">$</span><span class="va">asset_class</span> <span class="op">==</span> <span class="st">"Bond"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Bond: affected by rate shock and duration</span></span>
<span>      <span class="va">pnl</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">asset</span><span class="op">$</span><span class="va">position_value</span> <span class="op">*</span> <span class="va">scenario</span><span class="op">$</span><span class="va">rate_shock</span> <span class="op">*</span> <span class="va">asset</span><span class="op">$</span><span class="va">duration</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">asset</span><span class="op">$</span><span class="va">asset_class</span> <span class="op">==</span> <span class="st">"Commodity"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Commodity: direct commodity shock</span></span>
<span>      <span class="va">pnl</span> <span class="op">&lt;-</span> <span class="va">asset</span><span class="op">$</span><span class="va">position_value</span> <span class="op">*</span> <span class="va">scenario</span><span class="op">$</span><span class="va">commodity_shock</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">asset</span><span class="op">$</span><span class="va">asset_class</span> <span class="op">==</span> <span class="st">"FX"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># FX: direct fx shock</span></span>
<span>      <span class="va">pnl</span> <span class="op">&lt;-</span> <span class="va">asset</span><span class="op">$</span><span class="va">position_value</span> <span class="op">*</span> <span class="va">scenario</span><span class="op">$</span><span class="va">fx_shock</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">asset</span><span class="op">$</span><span class="va">asset_class</span> <span class="op">==</span> <span class="st">"Option"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Option: delta and vega exposure</span></span>
<span>      <span class="va">pnl</span> <span class="op">&lt;-</span> <span class="va">asset</span><span class="op">$</span><span class="va">position_value</span> <span class="op">*</span> <span class="va">scenario</span><span class="op">$</span><span class="va">equity_shock</span> <span class="op">*</span> <span class="va">asset</span><span class="op">$</span><span class="va">delta</span> <span class="op">+</span></span>
<span>             <span class="va">asset</span><span class="op">$</span><span class="va">vega</span> <span class="op">*</span> <span class="va">scenario</span><span class="op">$</span><span class="va">vol_shock</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">position_pnl</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pnl</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Aggregate results</span></span>
<span>  <span class="va">total_pnl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">position_pnl</span><span class="op">)</span></span>
<span>  <span class="va">portfolio_return</span> <span class="op">&lt;-</span> <span class="va">total_pnl</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">portfolio_data</span><span class="op">$</span><span class="va">position_value</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    scenario_id <span class="op">=</span> <span class="va">scenario</span><span class="op">$</span><span class="va">scenario_id</span>,</span>
<span>    scenario_type <span class="op">=</span> <span class="va">scenario</span><span class="op">$</span><span class="va">scenario_type</span>,</span>
<span>    total_pnl <span class="op">=</span> <span class="va">total_pnl</span>,</span>
<span>    portfolio_return <span class="op">=</span> <span class="va">portfolio_return</span>,</span>
<span>    equity_contribution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">position_pnl</span><span class="op">[</span><span class="va">portfolio_data</span><span class="op">$</span><span class="va">asset_class</span> <span class="op">==</span> <span class="st">"Equity"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    bond_contribution <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">position_pnl</span><span class="op">[</span><span class="va">portfolio_data</span><span class="op">$</span><span class="va">asset_class</span> <span class="op">==</span> <span class="st">"Bond"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    position_pnl <span class="op">=</span> <span class="va">position_pnl</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="local-execution">Local Execution<a class="anchor" aria-label="anchor" href="#local-execution"></a>
</h2>
<p>Test risk calculations locally on a small sample:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate sample scenarios</span></span>
<span><span class="va">test_stress</span> <span class="op">&lt;-</span> <span class="fu">generate_stress_scenarios</span><span class="op">(</span>n_scenarios <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">test_mc</span> <span class="op">&lt;-</span> <span class="fu">generate_mc_scenarios</span><span class="op">(</span>n_scenarios <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">test_stress</span>, <span class="va">test_mc</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Running local benchmark (%d scenarios)...\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">test_scenarios</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">local_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">local_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">test_scenarios</span>, <span class="va">value_portfolio_scenario</span>,</span>
<span>                       portfolio_data <span class="op">=</span> <span class="va">portfolio</span><span class="op">)</span></span>
<span></span>
<span><span class="va">local_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">local_start</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"✓ Completed in %.2f seconds\n"</span>, <span class="va">local_time</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Average time per scenario: %.3f seconds\n"</span>,</span>
<span>            <span class="va">local_time</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">test_scenarios</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Estimated time for 10,000 scenarios: %.1f minutes\n"</span>,</span>
<span>            <span class="va">local_time</span> <span class="op">*</span> <span class="fl">10000</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">test_scenarios</span><span class="op">)</span> <span class="op">/</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Typical output</strong>:</p>
<pre><code>Running local benchmark (120 scenarios)...
✓ Completed in 8.4 seconds
  Average time per scenario: 0.070 seconds
  Estimated time for 10,000 scenarios: 11.7 minutes</code></pre>
<p>For 10,000 scenarios locally: <strong>~12 minutes</strong></p>
</div>
<div class="section level2">
<h2 id="cloud-execution-with-starburst">Cloud Execution with staRburst<a class="anchor" aria-label="anchor" href="#cloud-execution-with-starburst"></a>
</h2>
<p>Run comprehensive risk analysis in parallel:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate full scenario set</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Generating scenario sets...\n"</span><span class="op">)</span></span>
<span><span class="va">stress_scenarios</span> <span class="op">&lt;-</span> <span class="fu">generate_stress_scenarios</span><span class="op">(</span>n_scenarios <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">mc_scenarios</span> <span class="op">&lt;-</span> <span class="fu">generate_mc_scenarios</span><span class="op">(</span>n_scenarios <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span><span class="va">sensitivity_scenarios</span> <span class="op">&lt;-</span> <span class="fu">generate_sensitivity_scenarios</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">all_scenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">stress_scenarios</span>, <span class="va">mc_scenarios</span>, <span class="va">sensitivity_scenarios</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Stress test scenarios: %d\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">stress_scenarios</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Monte Carlo scenarios: %s\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mc_scenarios</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Sensitivity scenarios: %d\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sensitivity_scenarios</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Total scenarios: %s\n\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">all_scenarios</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run parallel valuation</span></span>
<span><span class="va">n_workers</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Running risk analysis (%s scenarios) on %d workers...\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">all_scenarios</span><span class="op">)</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span>, <span class="va">n_workers</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cloud_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/starburst_map.html">starburst_map</a></span><span class="op">(</span></span>
<span>  <span class="va">all_scenarios</span>,</span>
<span>  <span class="va">value_portfolio_scenario</span>,</span>
<span>  portfolio_data <span class="op">=</span> <span class="va">portfolio</span>,</span>
<span>  workers <span class="op">=</span> <span class="va">n_workers</span>,</span>
<span>  cpu <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  memory <span class="op">=</span> <span class="st">"4GB"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cloud_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">cloud_start</span>, units <span class="op">=</span> <span class="st">"mins"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"\n✓ Completed in %.2f minutes\n"</span>, <span class="va">cloud_time</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Typical output</strong>:</p>
<pre><code>Generating scenario sets...
  Stress test scenarios: 100
  Monte Carlo scenarios: 10,000
  Sensitivity scenarios: 45
  Total scenarios: 10,145

🚀 Starting starburst cluster with 50 workers
💰 Estimated cost: ~$4.00/hour
📊 Processing 10145 items with 50 workers
📦 Created 50 chunks (avg 203 items per chunk)
🚀 Submitting tasks...
✓ Submitted 50 tasks
⏳ Progress: 50/50 tasks (1.8 minutes elapsed)

✓ Completed in 1.8 minutes
💰 Actual cost: $0.12</code></pre>
</div>
<div class="section level2">
<h2 id="risk-metrics-analysis">Risk Metrics Analysis<a class="anchor" aria-label="anchor" href="#risk-metrics-analysis"></a>
</h2>
<p>Calculate comprehensive risk metrics:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract P&amp;L from all scenarios</span></span>
<span><span class="va">pnl_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">total_pnl</span><span class="op">)</span></span>
<span><span class="va">return_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">portfolio_return</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Separate by scenario type</span></span>
<span><span class="va">stress_pnl</span> <span class="op">&lt;-</span> <span class="va">pnl_values</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span></span>
<span><span class="va">mc_pnl</span> <span class="op">&lt;-</span> <span class="va">pnl_values</span><span class="op">[</span><span class="fl">101</span><span class="op">:</span><span class="fl">10100</span><span class="op">]</span></span>
<span><span class="va">sensitivity_pnl</span> <span class="op">&lt;-</span> <span class="va">pnl_values</span><span class="op">[</span><span class="fl">10101</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pnl_values</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Comprehensive Risk Analysis Results ===\n\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Stress Test Results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"=== Stress Test Results ===\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Worst case loss: $%.0f (%.2f%%)\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">stress_pnl</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">stress_pnl</span><span class="op">)</span> <span class="op">/</span> <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Average stress loss: $%.0f (%.2f%%)\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">stress_pnl</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">stress_pnl</span><span class="op">)</span> <span class="op">/</span> <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Best case (least bad): $%.0f (%.2f%%)\n\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">stress_pnl</span><span class="op">)</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">stress_pnl</span><span class="op">)</span> <span class="op">/</span> <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Value at Risk (VaR) from Monte Carlo</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"=== Value at Risk (Monte Carlo) ===\n"</span><span class="op">)</span></span>
<span><span class="va">var_95</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mc_pnl</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">var_99</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mc_pnl</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">var_999</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mc_pnl</span>, <span class="fl">0.001</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"VaR (95%%): $%.0f (%.2f%%)\n"</span>,</span>
<span>            <span class="op">-</span><span class="va">var_95</span>, <span class="op">-</span><span class="va">var_95</span> <span class="op">/</span> <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"VaR (99%%): $%.0f (%.2f%%)\n"</span>,</span>
<span>            <span class="op">-</span><span class="va">var_99</span>, <span class="op">-</span><span class="va">var_99</span> <span class="op">/</span> <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"VaR (99.9%%): $%.0f (%.2f%%)\n\n"</span>,</span>
<span>            <span class="op">-</span><span class="va">var_999</span>, <span class="op">-</span><span class="va">var_999</span> <span class="op">/</span> <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Expected Shortfall (Conditional VaR)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"=== Expected Shortfall (CVaR) ===\n"</span><span class="op">)</span></span>
<span><span class="va">es_95</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mc_pnl</span><span class="op">[</span><span class="va">mc_pnl</span> <span class="op">&lt;=</span> <span class="va">var_95</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">es_99</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mc_pnl</span><span class="op">[</span><span class="va">mc_pnl</span> <span class="op">&lt;=</span> <span class="va">var_99</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"ES (95%%): $%.0f (%.2f%%)\n"</span>,</span>
<span>            <span class="op">-</span><span class="va">es_95</span>, <span class="op">-</span><span class="va">es_95</span> <span class="op">/</span> <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"ES (99%%): $%.0f (%.2f%%)\n\n"</span>,</span>
<span>            <span class="op">-</span><span class="va">es_99</span>, <span class="op">-</span><span class="va">es_99</span> <span class="op">/</span> <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Portfolio Statistics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"=== Portfolio Statistics ===\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Mean P&amp;L: $%.0f\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mc_pnl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Std Dev P&amp;L: $%.0f\n"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">mc_pnl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Skewness: %.3f\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">mc_pnl</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mc_pnl</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">mc_pnl</span><span class="op">)</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Probability of loss: %.2f%%\n\n"</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mc_pnl</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 5. Asset Class Contributions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"=== Risk Contribution by Asset Class ===\n"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ac</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">portfolio</span><span class="op">$</span><span class="va">asset_class</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ac_contrib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results</span><span class="op">[</span><span class="fl">101</span><span class="op">:</span><span class="fl">10100</span><span class="op">]</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">position_pnl</span><span class="op">[</span><span class="va">portfolio</span><span class="op">$</span><span class="va">asset_class</span> <span class="op">==</span> <span class="va">ac</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">ac_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">ac_contrib</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s VaR (95%%): $%.0f\n"</span>, <span class="va">ac</span>, <span class="op">-</span><span class="va">ac_var</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 6. Sensitivity Analysis Summary</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sensitivity_pnl</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Sensitivity Analysis ===\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Maximum sensitivity loss: $%.0f\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">sensitivity_pnl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Maximum sensitivity gain: $%.0f\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">sensitivity_pnl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Average absolute sensitivity: $%.0f\n"</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">sensitivity_pnl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># 7. Regulatory Metrics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\n=== Regulatory Metrics ===\n"</span><span class="op">)</span></span>
<span><span class="va">market_risk_capital</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">var_99</span> <span class="op">*</span> <span class="fl">3</span>  <span class="co"># Simplified Basel III calculation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Market Risk Capital Requirement: $%.0f\n"</span>, <span class="va">market_risk_capital</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Capital as %% of Portfolio: %.2f%%\n"</span>,</span>
<span>            <span class="va">market_risk_capital</span> <span class="op">/</span> <span class="va">total_portfolio_value</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><strong>Typical output</strong>:</p>
<pre><code>=== Comprehensive Risk Analysis Results ===

=== Stress Test Results ===
Worst case loss: $-12,845,234 (-20.56%)
Average stress loss: $-8,234,567 (-13.18%)
Best case (least bad): $-4,567,890 (-7.31%)

=== Value at Risk (Monte Carlo) ===
VaR (95%): $6,234,567 (9.98%)
VaR (99%): $9,876,543 (15.81%)
VaR (99.9%): $14,567,890 (23.32%)

=== Expected Shortfall (CVaR) ===
ES (95%): $8,456,789 (13.54%)
ES (99%): $11,234,567 (17.99%)

=== Portfolio Statistics ===
Mean P&amp;L: $-123,456
Std Dev P&amp;L: $3,456,789
Skewness: -0.234
Probability of loss: 51.23%

=== Risk Contribution by Asset Class ===
Equity VaR (95%): $4,234,567
Bond VaR (95%): $1,234,567
Commodity VaR (95%): $567,890
FX VaR (95%): $456,789
Option VaR (95%): $345,678

=== Sensitivity Analysis ===
Maximum sensitivity loss: $-234,567
Maximum sensitivity gain: $245,678
Average absolute sensitivity: $89,234

=== Regulatory Metrics ===
Market Risk Capital Requirement: $29,629,629
Capital as % of Portfolio: 47.44%</code></pre>
</div>
<div class="section level2">
<h2 id="performance-comparison">Performance Comparison<a class="anchor" aria-label="anchor" href="#performance-comparison"></a>
</h2>
<table class="table">
<thead><tr class="header">
<th>Method</th>
<th>Scenarios</th>
<th>Time</th>
<th>Cost</th>
<th>Speedup</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Local</td>
<td>120</td>
<td>8.4 sec</td>
<td>$0</td>
<td>-</td>
</tr>
<tr class="even">
<td>Local (est.)</td>
<td>10,145</td>
<td>11.9 min</td>
<td>$0</td>
<td>1x</td>
</tr>
<tr class="odd">
<td>staRburst</td>
<td>10,145</td>
<td>1.8 min</td>
<td>$0.12</td>
<td>6.6x</td>
</tr>
</tbody>
</table>
<p><strong>Key Insights</strong>: - Excellent speedup (6.6x) for risk
calculations - Enables daily comprehensive risk reporting -
Cost-effective even for large portfolios - Can scale to 100,000+
scenarios for more precision</p>
</div>
<div class="section level2">
<h2 id="advanced-incremental-risk-analysis">Advanced: Incremental Risk Analysis<a class="anchor" aria-label="anchor" href="#advanced-incremental-risk-analysis"></a>
</h2>
<p>Analyze marginal risk contribution of each position:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For each position, calculate VaR with and without it</span></span>
<span><span class="va">analyze_incremental_risk</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">position_idx</span>, <span class="va">scenarios</span>, <span class="va">portfolio_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create modified portfolio without this position</span></span>
<span>  <span class="va">modified_portfolio</span> <span class="op">&lt;-</span> <span class="va">portfolio_data</span></span>
<span>  <span class="va">original_value</span> <span class="op">&lt;-</span> <span class="va">modified_portfolio</span><span class="op">$</span><span class="va">position_value</span><span class="op">[</span><span class="va">position_idx</span><span class="op">]</span></span>
<span>  <span class="va">modified_portfolio</span><span class="op">$</span><span class="va">position_value</span><span class="op">[</span><span class="va">position_idx</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span></span>
<span>  <span class="co"># Value under all scenarios</span></span>
<span>  <span class="va">results_without</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">scenarios</span>, <span class="va">value_portfolio_scenario</span>,</span>
<span>                           portfolio_data <span class="op">=</span> <span class="va">modified_portfolio</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">pnl_without</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">results_without</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">total_pnl</span><span class="op">)</span></span>
<span>  <span class="va">var_without</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">pnl_without</span>, <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    position_idx <span class="op">=</span> <span class="va">position_idx</span>,</span>
<span>    asset_name <span class="op">=</span> <span class="va">portfolio_data</span><span class="op">$</span><span class="va">asset_name</span><span class="op">[</span><span class="va">position_idx</span><span class="op">]</span>,</span>
<span>    var_without <span class="op">=</span> <span class="va">var_without</span>,</span>
<span>    original_value <span class="op">=</span> <span class="va">original_value</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run in parallel (demonstration - would use smaller scenario set)</span></span>
<span><span class="co"># incremental_results &lt;- starburst_map(</span></span>
<span><span class="co">#   1:nrow(portfolio),</span></span>
<span><span class="co">#   analyze_incremental_risk,</span></span>
<span><span class="co">#   scenarios = mc_scenarios[1:1000],  # Use subset for speed</span></span>
<span><span class="co">#   portfolio_data = portfolio,</span></span>
<span><span class="co">#   workers = 25</span></span>
<span><span class="co"># )</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="when-to-use-this-pattern">When to Use This Pattern<a class="anchor" aria-label="anchor" href="#when-to-use-this-pattern"></a>
</h2>
<p><strong>Good fit</strong>: - Complex portfolio valuation (&gt; 0.1
seconds per scenario) - Large scenario sets (&gt; 1,000 scenarios) -
Daily risk reporting requirements - Regulatory stress testing -
Portfolio optimization</p>
<p><strong>Not ideal</strong>: - Very simple portfolios (linear
instruments only) - Real-time risk calculations - Small scenario sets
(&lt; 100 scenarios) - Portfolios with strong path dependencies</p>
</div>
<div class="section level2">
<h2 id="running-the-full-example">Running the Full Example<a class="anchor" aria-label="anchor" href="#running-the-full-example"></a>
</h2>
<p>The complete runnable script is available at:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/risk-modeling.R"</span>, package <span class="op">=</span> <span class="st">"starburst"</span><span class="op">)</span></span></code></pre></div>
<p>Run it with:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/risk-modeling.R"</span>, package <span class="op">=</span> <span class="st">"starburst"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<ul>
<li>Integrate with real portfolio management systems</li>
<li>Add historical simulation using actual market data</li>
<li>Implement more complex derivative pricing</li>
<li>Add scenario generation based on GARCH models</li>
<li>Create automated risk reporting dashboards</li>
</ul>
<p><strong>Related examples</strong>: - <a href="example-monte-carlo.html">Monte Carlo Simulation</a> - Similar
scenario-based pattern - <a href="example-bootstrap.html">Bootstrap
CI</a> - Statistical confidence intervals - <a href="example-feature-engineering.html">Feature Engineering</a> -
Data-intensive parallel processing</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>staRburst is developed by <a href="https://github.com/scttfrdmn" class="external-link">Scott Friedman</a>.</p>
<p>Contact: <a href="mailto:help@starburst.ing">help@starburst.ing</a></p>
</div>

<div class="pkgdown-footer-right">
  <p>Built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> and powered by <a href="https://paws-r.github.io/" class="external-link">paws</a>.</p>
</div>

    </footer>
</div>





  </body>
</html>
