#!/bin/bash
# Pre-commit hook to run R CMD check before pushing

echo "üîç Running R CMD check before commit..."

# Check if R is available
if ! command -v R &> /dev/null; then
    echo "‚ö†Ô∏è  R is not installed. Skipping check."
    exit 0
fi

# Run R CMD check
Rscript -e "
  if (!requireNamespace('devtools', quietly = TRUE)) {
    cat('‚ö†Ô∏è  devtools not installed. Install with: install.packages(\"devtools\")\n')
    quit(status = 0)
  }

  cat('Running devtools::check()...\n')
  result <- devtools::check(
    document = FALSE,
    args = '--no-manual --no-build-vignettes',
    error_on = 'error'
  )

  if (length(result\$errors) > 0) {
    cat('‚ùå R CMD check found errors:\n')
    print(result\$errors)
    quit(status = 1)
  }

  if (length(result\$warnings) > 0) {
    cat('‚ö†Ô∏è  R CMD check found warnings:\n')
    print(result\$warnings)
    cat('\nContinuing despite warnings. Consider fixing them.\n')
  }

  if (length(result\$notes) > 0) {
    cat('‚ÑπÔ∏è  R CMD check notes:\n')
    print(result\$notes)
  }

  cat('‚úÖ R CMD check passed!\n')
"

exit_code=$?

if [ $exit_code -ne 0 ]; then
    echo ""
    echo "‚ùå R CMD check failed!"
    echo "Fix the errors above before committing."
    echo ""
    echo "To skip this check (not recommended):"
    echo "  git commit --no-verify"
    exit 1
fi

echo "‚úÖ Pre-commit checks passed!"
exit 0
